
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Angular Testing - Let's Code</title>
  <meta name="author" content="Evan">

  
  <meta name="description" content="Testing angularJS with karma/jasmine. karma init installs jasmine 1.3 by default, 2.0 has cleaner syntax for asynchronous tests, but doesn&rsquo;t &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://evan-007.github.io/blog/2014/08/22/angular-testing">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Let's Code" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Let's Code</a></h1>
  
    <h2>Notes and thoughts</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:evan-007.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Angular Testing</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-22T10:29:56-04:00" pubdate data-updated="true">Aug 22<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Testing angularJS with karma/jasmine.<!--more--></p>

<p><code>karma init</code> installs jasmine 1.3 by default, 2.0 has cleaner syntax for asynchronous tests, but doesn&rsquo;t support all of the same libraries.</p>

<h2>Testing an Asynchronous Service with Jasmine 2.0</h2>

<p>If there is a service that uses promises, like:</p>

<figure class='code'><figcaption><span>angular_factory.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;myFactory&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span class='line'><span class="p">.</span><span class="nx">constant</span><span class="p">(</span><span class="s1">&#39;API_AUTH&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;username=demo&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="nx">constant</span><span class="p">(</span><span class="s1">&#39;COUNTRIES_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;http://api.geonames.org/countryInfoJSON?&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;CountryData&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;API_AUTH&#39;</span><span class="p">,</span><span class="s1">&#39;$http&#39;</span><span class="p">,</span><span class="s1">&#39;$q&#39;</span><span class="p">,</span> <span class="s1">&#39;COUNTRIES_PATH&#39;</span><span class="p">,</span>
</span><span class='line'><span class="kd">function</span> <span class="p">(</span><span class="nx">API_AUTH</span><span class="p">,</span> <span class="nx">$http</span><span class="p">,</span> <span class="nx">$q</span><span class="p">,</span> <span class="nx">COUNTRIES_PATH</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">countryId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">defer</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">COUNTRIES_PATH</span> <span class="o">+</span> <span class="s1">&#39;&amp;country=&#39;</span> <span class="o">+</span> <span class="nx">countryId</span> <span class="o">+</span> <span class="nx">API_AUTH</span><span class="p">,</span> <span class="p">{</span> <span class="nx">cache</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">geonames</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Any tests for this service will not resolve automatically because of the promise:</p>

<figure class='code'><figcaption><span>test.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;myFactory&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;never finishes&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">myService</span><span class="p">,</span> <span class="nx">$httpBackend</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">responseData</span> <span class="o">=</span> <span class="s1">&#39;hi&#39;</span>
</span><span class='line'>            <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">expectGET</span><span class="p">(</span><span class="sr">/http:\/\/\.api\.geonames\.com/</span><span class="p">).</span><span class="nx">respond</span><span class="p">(</span><span class="nx">responseData</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">myFactory</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>                <span class="nx">expect</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;I can write anything here because myFactory will never resolve&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This test will never fail because <code>myFactory</code> never resolves. In jasmine 2.0 pass <code>done</code> into the <code>it</code> block and call it
to resolve the asyn call:</p>

<figure class='code'><figcaption><span>test.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;finishes&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">myFactory</span><span class="p">,</span> <span class="nx">$httpBackend</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">responseData</span> <span class="o">=</span> <span class="s1">&#39;hi&#39;</span>
</span><span class='line'>        <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">expectGET</span><span class="p">(</span><span class="sr">/http:\/\/myServiceAPIcall\.com/</span><span class="p">).</span><span class="nx">respond</span><span class="p">(</span><span class="nx">responseData</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">myFactory</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">expect</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;it fails&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">done</span><span class="p">();</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This test actually runs and fails because <code>myFactory</code> runs and returns <code>hi!</code>.</p>

<p><code>Done</code> is only in jasmine 2.0!!!!!</p>

<p><a href="http://jasmine.github.io/2.0/introduction.html#section-Asynchronous_Support">http://jasmine.github.io/2.0/introduction.html#section-Asynchronous_Support</a>
1.3 has a different and less intuitive syntax:
<a href="http://jasmine.github.io/1.3/introduction.html#section-Asynchronous_Support">http://jasmine.github.io/1.3/introduction.html#section-Asynchronous_Support</a></p>

<h4>Loose-coupling on urls</h4>

<p>Using the full URL path with <code>$httpBackend</code> couples the test to the code.</p>

<pre><code>$httpBackend.expectGET('http://api.geonames.com/someendpoint?&amp;username=demo&amp;country=AU').respond(responseData);
</code></pre>

<p>This approach works, but if the URL ever needs to change in the service, then the test must also change.
Instead, use a minimal regex:</p>

<pre><code>$httpBackend.expectGET(/http:\/\/geonames\.com\.com/).respond(responseData);
</code></pre>

<p>As long as the URL the service calls matches that regex, <code>$httpBackend</code> will respond appropriately. Now, if the api endpoint or URL params change, the test doesn&rsquo;t need to change.</p>

<h2>Routing tests</h2>

<p>Given a basic route like:</p>

<figure class='code'><figcaption><span>app.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;cc-app&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="nx">config</span><span class="p">([</span><span class="s1">&#39;$routeProvider&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$routeProvider</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$routeProvider</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">&#39;/countries/:id&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;./country/country.html&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">controller</span><span class="o">:</span> <span class="s1">&#39;countryCtrl&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">resolve</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">ActiveCountry</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;CountryData&#39;</span><span class="p">,</span> <span class="s1">&#39;$route&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">CountryData</span><span class="p">,</span> <span class="nx">$route</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="nx">CountryData</span><span class="p">(</span><span class="nx">$route</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="p">}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>An easy test would be:</p>

<figure class='code'><figcaption><span>app_spec.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;country.js&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;cc-app&#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should load the correct template and controller&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$route</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">expect</span><span class="p">(</span><span class="nx">$route</span><span class="p">.</span><span class="nx">routes</span><span class="p">[</span><span class="s1">&#39;/countries/:id&#39;</span><span class="p">].</span><span class="nx">controller</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;countryCtrl&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">expect</span><span class="p">(</span><span class="nx">$route</span><span class="p">.</span><span class="nx">routes</span><span class="p">[</span><span class="s1">&#39;/countries/:id&#39;</span><span class="p">].</span><span class="nx">templateUrl</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;./country/country.html&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works, but it&rsquo;s not very good. If the app is reorganized, then any test like this will have to change because the paths in the <code>expect</code> won&rsquo;t match.</p>

<p>This test also isn&rsquo;t really testing anything other than the configurations &ndash; it doesn&rsquo;t load the route in the test block. A better test would actually load the route:</p>

<figure class='code'><figcaption><span>app_spec.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should load the correct template and controller&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$httpBackend</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$route</span><span class="p">){</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;FR&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">expectGET</span><span class="p">(</span><span class="s1">&#39;/country.html&#39;</span><span class="p">).</span><span class="nx">respond</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>            <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">&#39;/countries/&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">verifyNoOutstandingRequest</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">expect</span><span class="p">(</span><span class="nx">$route</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">controller</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;countryCtrl&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">expect</span><span class="p">(</span><span class="nx">$route</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">templateUrl</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;./country/country.html&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is nicer since it actually instantiates the route. We could also use a regex for the <code>templateUrl</code> to make the code easier to change later.</p>

<p>But this test has an asynchronous request problem: the service in the <code>resolve</code> block never resolves, so the will fail with an <code>unexpected request</code> from the route <code>resolve</code>. We could use <code>$httpBackend</code> and <code>done</code> like in the previous example, but since we&rsquo;ve already written a test for that service, does it really need to be tested again? And does this routing test even need to know that <code>resolve</code> calls an asynchronous function? An alternative would be to double it out with a <code>spy</code>.</p>

<p><a href="http://jasmine.github.io/2.0/introduction.html#section-Spies">http://jasmine.github.io/2.0/introduction.html#section-Spies</a></p>

<p>A spy is a double of a function. Instead of calling a function, the test will call the spy which can be created to behave like the function it replaces, but without the asynchronous call. In jasmine, there are matchers to confirm that the spy is behaving as it should.</p>

<p>In Jasmine spies are objects and so to properly double a function, it needs to be the method of some object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fakeData</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">stuff</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">){</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">arg</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is just a plain old javascript object: <code>fakeData.stuff('whatever');</code></p>

<p>The spy is setup like this: <code>spyOn(fakeData, 'stuff');</code>. <code>spyOn</code> takes two arguments: the object and one of its properties. All this means is that jasmine is now paying attention to <code>fakeData.stuff</code>. The test now has access to the <code>toHaveBeenCalled()</code> matcher that verifies that the function was actually called in the test block.</p>

<p>The next step is to tell angular to use the spy in place of the function it doubles. <code>$provide</code> is how angular registers components to inject them into a module, so the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$provide</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">$provide</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;CountryData&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">fakeData</span><span class="p">.</span><span class="nx">stuff</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>tells angular to use <code>fakeData.stuff</code> when the <code>CountryData</code> factory is called. Remember the <code>resolve</code> in the controller?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">resolve</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">ActiveCountry</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;CountryData&#39;</span><span class="p">,</span> <span class="s1">&#39;$route&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">CountryData</span><span class="p">,</span> <span class="nx">$route</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">CountryData</span><span class="p">(</span><span class="nx">$route</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This resolve needs a function that takes one argument, which is exactly what <code>fakeData.stuff</code> will do. The return value of this factory doesn&rsquo;t matter so much since we&rsquo;re only testing the route: it&rsquo;s the controller&rsquo;s job to set <code>ActiveCountry</code> to the appropriate <code>scope</code>.</p>

<p>The full test looks like this:</p>

<figure class='code'><figcaption><span>app_spec.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;country.js&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">fakeData</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">stuff</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">){</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">arg</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;cc-app&#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">spyOn</span><span class="p">(</span><span class="nx">fakeData</span><span class="p">,</span> <span class="s1">&#39;stuff&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">module</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$provide</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">$provide</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;CountryData&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>                <span class="k">return</span> <span class="nx">fakeData</span><span class="p">.</span><span class="nx">stuff</span><span class="p">;</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should load the correct template and controller&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$httpBackend</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$route</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;FR&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">expectGET</span><span class="p">(</span><span class="s1">&#39;./country/country.html&#39;</span><span class="p">).</span><span class="nx">respond</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>                <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">&#39;/countries/&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
</span><span class='line'>            <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">verifyNoOutstandingRequest</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">expect</span><span class="p">(</span><span class="nx">$route</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">controller</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;countryCtrl&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">expect</span><span class="p">(</span><span class="nx">$route</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">templateUrl</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">&#39;./country/country.html&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">expect</span><span class="p">(</span><span class="nx">fakeData</span><span class="p">.</span><span class="nx">stuff</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that instead of just <code>expect(fakeData.stuff).toHaveBeenCalled();</code> there is another matcher <code>toHaveBeenCalled()</code> that can verify that the correct arguments were also passed.</p>

<p>The first routing test only verified that the router was configured correctly. This much-improved version verifies that given the url <code>/countries/:id</code>, the router loads the correct controller and template AND passes the correct params from the url to <code>resolve</code> which then runs some function that takes those params as an argument.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Evan</span></span>

      








  


<time datetime="2014-08-22T10:29:56-04:00" pubdate data-updated="true">Aug 22<span>nd</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://evan-007.github.io/blog/2014/08/22/angular-testing/" data-via="" data-counturl="http://evan-007.github.io/blog/2014/08/22/angular-testing/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/08/19/refactor/" title="Previous Post: Controller PORO Refactor">&laquo; Controller PORO Refactor</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/09/05/restangular/" title="Next Post: Angular Backend Communication">Angular Backend Communication &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/29/qunit-testing/">Qunit Testing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/29/ember-madlibs/">Ember Madlibs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/16/ember-devise-simple-auth/">Ember Devise Simple Auth</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/22/more-rails-refactoring/">More Rails Refactoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/11/protractor-testing/">Protractor Testing</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/evan-007">@evan-007</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'evan-007',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Evan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'letscodeghpages';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://evan-007.github.io/blog/2014/08/22/angular-testing/';
        var disqus_url = 'http://evan-007.github.io/blog/2014/08/22/angular-testing/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
